name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test-sonar:
    runs-on: windows-latest

    env:
      DOTNET_VERSION: '8.0.x'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install SonarScanner for .NET
        shell: powershell
        run: dotnet tool install --global dotnet-sonarscanner

      - name: dotnet format (solution)
        shell: powershell
        run: |
          dotnet format --verify-no-changes
          dotnet build "$env:GITHUB_WORKSPACE\BMTH Application (back end)\BMTH Application (back end).sln" `
            --configuration Release `
            /p:TreatWarningsAsErrors=true

      - name: Create coverage output folder
        run: mkdir "${{ github.workspace }}/coverage"

      - name: Begin Sonar Analysis
        shell: powershell
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          $scanner = "$env:USERPROFILE\.dotnet\tools\dotnet-sonarscanner"
          & $scanner begin `
            /k:"Gifmaniac_BMTHBackend2" `
            /o:"gifmaniac" `
            /d:sonar.host.url="https://sonarcloud.io" `
            /d:sonar.token="$env:SONAR_TOKEN" `
            /d:sonar.cs.opencover.reportsPaths="${{ github.workspace }}/coverage/coverage.integration.opencover.xml" `
            /d:sonar.coverage.exclusions='**/DataLayer/Context/**,**/DataLayer/Models/**,**/DataLayer/Migrations/**,**/Contracts/**,**/BusinessLayer/Exceptions/**,**/*.g.cs,**/obj/**,**/bin/**,"**/BMTH Application (back end)/**"' `
            /d:sonar.inclusions='**/BusinessLayer/**,**/DataLayer/Repositories/**'

      - name: Restore
        shell: powershell
        run: |
          dotnet restore "$env:GITHUB_WORKSPACE/BMTH Application (back end)/BMTH Application (back end).sln"

      - name: Build
        shell: powershell
        run: |
          dotnet build "$env:GITHUB_WORKSPACE/BMTH Application (back end)/BMTH Application (back end).sln" --no-restore

      - name: Run Unit Tests + Coverage
        shell: powershell
        working-directory: "${{ github.workspace }}/BMTH Application (back end)/Test.Unit"
        run: |
          dotnet test Test.Unit.csproj `
            /p:CollectCoverage=true `
            /p:CoverletOutputFormat=opencover `
            /p:CoverletOutput="${{ github.workspace }}/coverage/coverage.unit.opencover.xml"

      - name: Run Integration Tests + Coverage
        shell: powershell
        working-directory: "${{ github.workspace }}/BMTH Application (back end)/Test.Integration"
        run: |
          dotnet test Test.Integration.csproj `
            /p:CollectCoverage=true `
            /p:CoverletOutputFormat=opencover `
            /p:CoverletOutput="${{ github.workspace }}/coverage/coverage.integration.opencover.xml" `
            /p:MergeWith="${{ github.workspace }}/coverage/coverage.unit.opencover.xml"

      - name: End Sonar Analysis
        shell: powershell
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          $scanner = "$env:USERPROFILE\.dotnet\tools\dotnet-sonarscanner"
          & $scanner end `
            /d:sonar.token="$env:SONAR_TOKEN"
